# Flash-Sale

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨goå®ç°çš„å¹¶å‘æŠ¢ç¥¨ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ­£ç¡®ã€å¿«é€Ÿå¤„ç†é«˜å¹¶å‘é‡ä¸‹çš„è®¢ç¥¨è¯·æ±‚ï¼Œé¿å…è¶…å–å’Œé‡å¤è´­ä¹°ï¼Œå¹¶èƒ½å¤Ÿä¿è¯Redisä¸æ•°æ®åº“ä¸­è®¢å•çš„ä¸€è‡´æ€§

## ä½¿ç”¨çš„æŠ€æœ¯

- Webæ¡†æ¶ Gin
- æ•°æ®åº“ Postgresql Gorm 
- ç¼“å­˜ Redis lua script
- æ¶ˆæ¯é˜Ÿåˆ— rabbitMQ

## é¡¹ç›®è®¾è®¡

### ä¼˜å…ˆå“åº”ç”¨æˆ·çš„è®¢ç¥¨è¯·æ±‚

é€šè¿‡ä½¿ç”¨RabbitMQåœ¨ ç”¨æˆ·è®¢ç¥¨ã€æ”¯ä»˜åŠŸèƒ½ã€å†™å…¥è®¢å•åˆ°æ•°æ®åº“ è¿™äº›serviceä¹‹é—´ä¼ é€’æ¶ˆæ¯ï¼Œä½¿å„éƒ¨åˆ†å¯ä»¥å¼‚æ­¥è¿è¡Œ

è¿™ä½¿å¾— å¯ä»¥ç›´æ¥è¯»å–Redisä¸­çš„ä¿¡æ¯æ¥å†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·çš„è®¢ç¥¨è¯·æ±‚ï¼Œè€Œæ— é¡»è®¿é—®æ•°æ®åº“ï¼Œå› æ­¤ä¸ä¼šè¢«æ•°æ®åº“é˜»å¡ï¼ŒåŠ å¿«äº†å¤„ç†é€Ÿåº¦

ServiceåŒ…å«ä¸¤ä¸ªåŒ… domainå’Œworkflowï¼Œåœ¨domainä¸­æ˜¯ä¸ä½¿ç”¨RabbitMQçš„å„ç§åŸºæœ¬æœåŠ¡ï¼ŒwokflowåŒ…ä¸­åˆ™æ˜¯æœ‰rabbitMQçš„æœåŠ¡

### ä¿è¯æ•°æ®çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§

æ— è®ºåœ¨Redisè¿˜æ˜¯åœ¨Postgresqlä¸­ï¼Œéƒ½ä½¿ç”¨åŸå­æ“ä½œæ¥ä¿è¯é€»è¾‘ä¸Šçš„æ­£ç¡®æ€§ã€‚ä¹Ÿé¿å…äº†åœ¨redisä¸­è¯»åˆ°è¿˜æœ‰ä½™ç¥¨ï¼Œä½†å†™å…¥æ—¶å·²ç»æ²¡æœ‰ä½™ç¥¨ è€Œå¼•å‘çš„è¶…è®¢é—®é¢˜

Redisç”¨luaè„šæœ¬ï¼Œ Postgresqlä½¿ç”¨GORMæä¾›çš„Transaction

### ç”¨æˆ·è®¢ç¥¨æœºåˆ¶

ç”¨æˆ·è¯·æ±‚è®¢æŸä¸€å¼ ç¥¨ -> åœ¨redisä¸­æŸ¥è¯¢è¿˜æœ‰ä½™ç¥¨ä¸”ç”¨æˆ·æ²¡æœ‰è®¢è¿‡è¿™åœºç”µå½±->é€šè¿‡MQå‘é€ç»™payment serviceä¸¤æ¡ä¿¡æ¯ï¼Œä¸€æ¡æ˜¯æ¨¡æ‹Ÿç”¨æˆ·æ”¯ä»˜è¡Œä¸ºï¼Œå¦ä¸€æ¡ç»è¿‡ä¸€ä¸ª15minsçš„å»¶æ—¶é˜Ÿåˆ—ï¼Œ15åˆ†é’Ÿåå¦‚æœç”¨æˆ·è¿˜æ²¡æœ‰æ”¯ä»˜æˆåŠŸï¼Œè¿™æ¡æ¶ˆæ¯ä¼šå–æ¶ˆç”¨æˆ·çš„è®¢å•å¹¶è¿”è¿˜åº“å­˜ -> æ”¯ä»˜æˆåŠŸåé€šè¿‡MQå‘ä¿¡æ¯ç»™orderæ•°æ®åº“æœåŠ¡ï¼Œå†™å…¥è®¢å•åˆ°æ•°æ®åº“

### Layers:

model - repositorty - domain service - workflow service - app - handler

ç»“æ„æ¸…æ™°ï¼Œè¾¹ç•Œåˆ†æ˜ï¼Œæ˜“äºæ‹“å±•

## æ–‡ä»¶æ ‘

```text
## é¡¹ç›®ç»“æ„

```text
flash-sale/
â”œâ”€â”€ cmd
â”‚   â””â”€â”€ flash-sale
â”‚       â””â”€â”€ main.go              # ç¨‹åºå…¥å£
â”œâ”€â”€ config
â”‚   â””â”€â”€ config.go                # é…ç½®åŠ è½½
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ internal
â”‚   â”œâ”€â”€ app
â”‚   â”‚   â””â”€â”€ app.go               # åº”ç”¨åˆå§‹åŒ–
â”‚   â”œâ”€â”€ cache
â”‚   â”‚   â”œâ”€â”€ constants.go         # Redis key / å¸¸é‡
â”‚   â”‚   â””â”€â”€ redis.go             # Redis æ“ä½œå°è£…
â”‚   â”œâ”€â”€ handler
â”‚   â”‚   â””â”€â”€ handler.go           # HTTP æ¥å£å±‚
â”‚   â”œâ”€â”€ model
â”‚   â”‚   â””â”€â”€ model.go             # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ mq
â”‚   â”‚   â”œâ”€â”€ constants.go         # MQ å¸¸é‡
â”‚   â”‚   â”œâ”€â”€ producer.go          # æ¶ˆæ¯ç”Ÿäº§è€…
â”‚   â”‚   â””â”€â”€ rabbitmq.go          # RabbitMQ å°è£…
â”‚   â”œâ”€â”€ repository
â”‚   â”‚   â”œâ”€â”€ movie_repo.go        # å•†å“/å½±ç‰‡æ•°æ®è®¿é—®
â”‚   â”‚   â”œâ”€â”€ order_repo.go        # è®¢å•æ•°æ®è®¿é—®
â”‚   â”‚   â”œâ”€â”€ showtime_repo.go     # åœºæ¬¡/åº“å­˜æ•°æ®è®¿é—®
â”‚   â”‚   â””â”€â”€ user_repo.go         # ç”¨æˆ·æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ service
â”‚   â”‚   â”œâ”€â”€ domain
â”‚   â”‚   â”‚   â”œâ”€â”€ movie_service.go
â”‚   â”‚   â”‚   â”œâ”€â”€ order_service.go
â”‚   â”‚   â”‚   â”œâ”€â”€ payment_service.go
â”‚   â”‚   â”‚   â”œâ”€â”€ reservation_service.go
â”‚   â”‚   â”‚   â””â”€â”€ showtime_service.go
â”‚   â”‚   â”œâ”€â”€ errors.go            # ä¸šåŠ¡é”™è¯¯å®šä¹‰
â”‚   â”‚   â””â”€â”€ workflow
â”‚   â”‚       â”œâ”€â”€ order_workflow.go
â”‚   â”‚       â”œâ”€â”€ payment_workflow.go
â”‚   â”‚       â””â”€â”€ reservation_workflow.go
â”‚   â””â”€â”€ util
â”‚       â””â”€â”€ env.go               # ç¯å¢ƒå˜é‡å·¥å…·
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ server.log
â””â”€â”€ test
    â””â”€â”€ concurrent_test.go       # å¹¶å‘å‹æµ‹
```

## å¹¶å‘æµ‹è¯•

./test/concurrent_test.goè¿›è¡Œäº†ä¸‰ä¸ªæµ‹è¯•(å·²è¿›è¡Œé‡å¤æµ‹è¯•)

### æµ‹è¯•åœºæ™¯ä¸€ï¼š7000ç”¨æˆ·åŒæ—¶æŠ¢100å¼ ç¥¨

7000ä¸ªä¸åŒidçš„ç”¨æˆ·åŒæ—¶è¯·æ±‚æŠ¢åŒä¸€å¼ ç¥¨ï¼Œæ˜¾ç¤ºæœ‰æ•ˆé¿å…è¶…å–ï¼Œç­‰å¾…3ç§’ä½¿æ•°æ®åº“èƒ½å¤Ÿå…¨éƒ¨å†™å…¥åï¼Œæ£€æµ‹åˆ°æ•°æ®åº“è®¢å•é‡æ­£ç¡®

æ¯ç§’èƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚æ•°ï¼ˆQPSï¼‰ä¸º20573.43, æ€§èƒ½è¾ƒé«˜

```shell
go test -v ./test/concurrent_test.go
=== RUN   TestConcurrent_OversellPrevention
    concurrent_test.go:92: âœ… æµ‹è¯•æ•°æ®åˆå§‹åŒ–å®Œæˆ: 7000ä¸ªç”¨æˆ·, 1ä¸ªåœºæ¬¡, æ¯åœº100 å¼ ç¥¨
    concurrent_test.go:238:
        ğŸ¯ åœºæ™¯1: æé™æŠ¢ç¥¨æµ‹è¯•
    concurrent_test.go:239: ç¥¨æ•°: 100, å¹¶å‘ç”¨æˆ·: 7000
    concurrent_test.go:203:
        ============================================================
    concurrent_test.go:204: ğŸ“Š åœºæ™¯1: è¶…å–æµ‹è¯• - æµ‹è¯•ç»“æœ
    concurrent_test.go:205: ============================================================
    concurrent_test.go:206: âœ… æˆåŠŸé¢„è®¢: 100
    concurrent_test.go:207: ğŸ”´ å·²å”®ç½„: 6900
    concurrent_test.go:208: ğŸ” é‡å¤é¢„è®¢: 0
    concurrent_test.go:209: âŒ å…¶ä»–é”™è¯¯: 0
    concurrent_test.go:210: ğŸ“ˆ æ€»è¯·æ±‚æ•°: 7000
    concurrent_test.go:211: â±ï¸  æ€»è€—æ—¶: 340.244709ms
    concurrent_test.go:212: âš¡ å¹³å‡å“åº”æ—¶é—´: 225.429043ms
    concurrent_test.go:213: ğŸš€ QPS: 20573.43
    concurrent_test.go:214: ============================================================
    concurrent_test.go:251: âœ… è¶…å–æ£€æµ‹é€šè¿‡ï¼
è®¢ç¥¨å·²å®Œæˆï¼Œç­‰å¾…3ç§’ä¿è¯æ•°æ®åº“å†™å…¥å®Œæˆ
    concurrent_test.go:224: âœ… æ•°æ®åº“éªŒè¯é€šè¿‡: 100 æ¡è®¢å•
--- PASS: TestConcurrent_OversellPrevention (4.18s)

```

å¦‚æœè®¾ç½®å¹¶å‘è¯·æ±‚é‡>10000ï¼Œç”±äºæˆ‘çš„ç”µè„‘æ€§èƒ½é™åˆ¶ï¼Œä¼šå‡ºç°   concurrent_test.go:170: âŒ è¯·æ±‚é”™è¯¯ [ç”¨æˆ·18890]: Post "http://127.0.0.1:4000/reserve": dial tcp 127.0.0.1:4000: socket: too many open files é”™è¯¯ï¼Œè¿™åº”è¯¥æ˜¯å› ä¸ºç”µè„‘èµ„æºè€—å°½å¯¼è‡´çš„ï¼Œå› æ­¤æˆ‘æ— æ³•è¿›è¡Œå¹¶å‘è¯·æ±‚é‡æ›´å¤§çš„æµ‹è¯•

### æµ‹è¯•åœºæ™¯äºŒï¼šåŒä¸€ç”¨æˆ·å¹‚ç­‰æ€§æµ‹è¯•

é˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤è®¢ç¥¨

```shell
    concurrent_test.go:204: ğŸ“Š åœºæ™¯2: å¹‚ç­‰æ€§æµ‹è¯• - æµ‹è¯•ç»“æœ
    concurrent_test.go:205: ============================================================
    concurrent_test.go:206: âœ… æˆåŠŸé¢„è®¢: 1
    concurrent_test.go:207: ğŸ”´ å·²å”®ç½„: 0
    concurrent_test.go:208: ğŸ” é‡å¤é¢„è®¢: 19
    concurrent_test.go:209: âŒ å…¶ä»–é”™è¯¯: 0
    concurrent_test.go:210: ğŸ“ˆ æ€»è¯·æ±‚æ•°: 20
    concurrent_test.go:211: â±ï¸  æ€»è€—æ—¶: 1.928875ms
    concurrent_test.go:212: âš¡ å¹³å‡å“åº”æ—¶é—´: 1.023789ms
    concurrent_test.go:213: ğŸš€ QPS: 10368.74
    concurrent_test.go:214: ============================================================
    concurrent_test.go:289: âœ… å¹‚ç­‰æ€§æ£€æµ‹é€šè¿‡ï¼
è®¢ç¥¨å·²å®Œæˆï¼Œç­‰å¾…3ç§’ä¿è¯æ•°æ®åº“å†™å…¥å®Œæˆ
    concurrent_test.go:224: âœ… æ•°æ®åº“éªŒè¯é€šè¿‡: 1 æ¡è®¢å•
--- PASS: TestConcurrent_IdempotencyCheck (3.06s)
```

### æµ‹è¯•åœºæ™¯ä¸‰: å¤šåœºæ¬¡æ··åˆæµ‹è¯•

```shell
=== RUN   TestConcurrent_MultipleShowtimes
    concurrent_test.go:92: âœ… æµ‹è¯•æ•°æ®åˆå§‹åŒ–å®Œæˆ: 1000ä¸ªç”¨æˆ·, 3ä¸ªåœºæ¬¡, æ¯åœº50å¼ ç¥¨
    concurrent_test.go:313:
        ğŸ¯ åœºæ™¯3: å¤šåœºæ¬¡æ··åˆæµ‹è¯•
    concurrent_test.go:314: 3ä¸ªåœºæ¬¡, æ¯åœº50å¼ ç¥¨, æ€»å¹¶å‘: 3000
è®¢ç¥¨å·²å®Œæˆï¼Œç­‰å¾…3ç§’ä¿è¯æ•°æ®åº“å†™å…¥å®Œæˆ
    concurrent_test.go:203:
        ============================================================
    concurrent_test.go:204: ğŸ“Š åœºæ™¯3-åœºæ¬¡1 - æµ‹è¯•ç»“æœ
    concurrent_test.go:205: ============================================================
    concurrent_test.go:206: âœ… æˆåŠŸé¢„è®¢: 50
    concurrent_test.go:207: ğŸ”´ å·²å”®ç½„: 950
    concurrent_test.go:208: ğŸ” é‡å¤é¢„è®¢: 0
    concurrent_test.go:209: âŒ å…¶ä»–é”™è¯¯: 0
    concurrent_test.go:210: ğŸ“ˆ æ€»è¯·æ±‚æ•°: 1000
    concurrent_test.go:211: â±ï¸  æ€»è€—æ—¶: 89.633416ms
    concurrent_test.go:212: âš¡ å¹³å‡å“åº”æ—¶é—´: 47.960918ms
    concurrent_test.go:213: ğŸš€ QPS: 11156.55
    concurrent_test.go:214: ============================================================
    concurrent_test.go:224: âœ… æ•°æ®åº“éªŒè¯é€šè¿‡: 50 æ¡è®¢å•
    concurrent_test.go:203:
        ============================================================
    concurrent_test.go:204: ğŸ“Š åœºæ™¯3-åœºæ¬¡2 - æµ‹è¯•ç»“æœ
    concurrent_test.go:205: ============================================================
    concurrent_test.go:206: âœ… æˆåŠŸé¢„è®¢: 50
    concurrent_test.go:207: ğŸ”´ å·²å”®ç½„: 950
    concurrent_test.go:208: ğŸ” é‡å¤é¢„è®¢: 0
    concurrent_test.go:209: âŒ å…¶ä»–é”™è¯¯: 0
    concurrent_test.go:210: ğŸ“ˆ æ€»è¯·æ±‚æ•°: 1000
    concurrent_test.go:211: â±ï¸  æ€»è€—æ—¶: 89.616709ms
    concurrent_test.go:212: âš¡ å¹³å‡å“åº”æ—¶é—´: 48.939644ms
    concurrent_test.go:213: ğŸš€ QPS: 11158.63
    concurrent_test.go:214: ============================================================
    concurrent_test.go:224: âœ… æ•°æ®åº“éªŒè¯é€šè¿‡: 50 æ¡è®¢å•
    concurrent_test.go:203:
        ============================================================
    concurrent_test.go:204: ğŸ“Š åœºæ™¯3-åœºæ¬¡3 - æµ‹è¯•ç»“æœ
    concurrent_test.go:205: ============================================================
    concurrent_test.go:206: âœ… æˆåŠŸé¢„è®¢: 50
    concurrent_test.go:207: ğŸ”´ å·²å”®ç½„: 950
    concurrent_test.go:208: ğŸ” é‡å¤é¢„è®¢: 0
    concurrent_test.go:209: âŒ å…¶ä»–é”™è¯¯: 0
    concurrent_test.go:210: ğŸ“ˆ æ€»è¯·æ±‚æ•°: 1000
    concurrent_test.go:211: â±ï¸  æ€»è€—æ—¶: 89.828333ms
    concurrent_test.go:212: âš¡ å¹³å‡å“åº”æ—¶é—´: 43.836538ms
    concurrent_test.go:213: ğŸš€ QPS: 11132.35
    concurrent_test.go:214: ============================================================
    concurrent_test.go:224: âœ… æ•°æ®åº“éªŒè¯é€šè¿‡: 50 æ¡è®¢å•
    concurrent_test.go:351:
        ğŸ“Š å¤šåœºæ¬¡æ€»ç»“: æ€»æˆåŠŸé¢„è®¢ 150 ç¬”
--- PASS: TestConcurrent_MultipleShowtimes (3.48s)
```

## ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªé¡¹ç›®

æˆ‘åœ¨æ„å»º github.com/qs-lzh/movie-reservation é¡¹ç›®æ—¶ï¼Œè®¤ä¸ºå¯ä»¥å°è¯•æ‹“å±•é¡¹ç›®ä½¿ä¹‹èƒ½å¤Ÿå¤„ç†é«˜å¹¶å‘ï¼Œä½†è€ƒè™‘åˆ°ä»£ç é‡è¾ƒå¤§ï¼Œæ‰€ä»¥å°†é¡¹ç›®çš„ä¸€éƒ¨ä»½åç«¯ç®€åŒ–å¹¶åˆ†ç¦»å‡ºæ¥ï¼Œå•ç‹¬å†™æˆè¿™ä¸ªé¡¹ç›®ã€‚
